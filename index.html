<html>
<head>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.5.0/dist/aframe-cursor-teleport-component.min.js"></script>
  <!-- <link rel="stylesheet" type="text/css" href="./styles.css"> -->
  <link rel="stylesheet" type="text/css" href="./styles.css">

</head>




<body>


  <a-scene device-orientation-permission-ui="enabled: false"
  cursor="rayOrigin: mouse">
    <a-assets>
    
    <a-asset-item id="lobby" src="./Models/Hallway-new.glb"></a-asset-item>
    <!-- <a-asset-item id="lobby" src="./Models/room_modify.glb"></a-asset-item> -->
      <img id="welcome" src="./Images/nav-tips.png">
      <img id="footprint" src="./Images/footprint-new.png">
      <img id="ring-glow" src="./Images/ringGlow.png">
      <!-- <img id="floor" src="./Images/floor-texture.jpeg"> -->
      <img id="floor" src="./Images/texture-new.png">
      <img id="label0" src="./Images/room-label0.png">
      <img id="label1" src="./Images/room-label1.png">
      <img id="hover-text" src="./Images/hover-text-new.png">
      <img id="loading" src="./Images/loading.png">
    </a-assets>

    <a-entity light="type: ambient; color: #FFF; intensity: 20" position="-0.5 3 1"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 1" position="0.6 3 4"></a-entity>

    <a-entity id="light1" light="type: spot; color: #ffdbea; intensity: 0.5 angle: 120" position="-1.38 0.44 -2.5" rotation="0 0 0"></a-entity>
    <a-entity id="light2" light="type: directional; color: #FFF; intensity: 0.4" position="-6 -5 -6" rotation="0 90 0"></a-entity>
    <a-entity id="light3" light="type: spot; color: #f8e2ea; intensity: 0.95; angle: 120; " position="-11.4 6.24 -20"></a-entity>



    <a-entity id="cameraRig" cursor-teleport="cameraRig: #cameraRig; cameraHead: #head; ignoreEntities: .clickable">
      <a-entity id="head" position="0 2.5 0" camera look-controls="reverseMouseDrag: true" wasd-controls="acceleration:60"
      restrict-movement="minX: -16; maxX: 7; minZ: -20; maxZ: 2" 
      proximity-audio-trigger
      ></a-entity>
      <a-entity laser-controls="hand: left" raycaster="objects: .clickable; far: 100" line="color: red; opacity: 0.75"
        blink-controls="cameraRig: #cameraRig; teleportOrigin: #head;"></a-entity>
      <a-entity laser-controls="hand: right" raycaster="objects: .clickable" line="color: red; opacity: 0.75"
        blink-controls="cameraRig: #cameraRig; teleportOrigin: #head;"></a-entity>
    </a-entity>


    <a-entity gltf-model="#lobby" scale="2.5 2.5 2.5" position="2 -0.24 10" rotation="0 180 0"> 
    </a-entity>
    <a-entity geometry="primitive:plane" position="0 0.035 -16" rotation="-90 0 0" scale="50 50 50" id="roof" material="src:#floor;color:#d1c9c9; shader:flat" ></a-entity>
    <a-entity geometry="primitive:plane" position="-8.73 7.245 -18" rotation="90 0 0" scale="50 50 50" id="roof" material="color:#fbe7ca; shader:flat" ></a-entity>

    <!-- <a-entity environment="preset: default"></a-entity> -->


    <a-entity id="footprint-group" rotation="-90 25 0" position="-3.28 0.062 -1.88"> 
      <a-image src="#footprint" position="-1.27 1.106 0" rotation="0 0 0" scale="0.5"></a-image>
      <a-image src="#footprint" position="-2.2 3.12 0" rotation="0 0 0" scale="0.5"> </a-image>
      <a-image src="#footprint" position="-3.31 4.8 0" rotation=0 0 0" scale="0.5"> </a-image>
      <a-image src="#footprint" position="-4.8 6.8 0" rotation=0 0 0" scale="0.5"> </a-image>
      <a-image src="#footprint" position="-6.2 9.8 0" rotation=0 0 0" scale="0.5"> </a-image>
    </a-entity>

  
  
  <a-image src="#ring-glow" position="-20.3 0.06 -19.5" rotation="90 0 0" scale="25 25 25"
  class="clickable interactive-image" 
  id="teleport-ring0"
  >

<a-image src="#hover-text" class="hover-text" scale="0.11 0.05 0.05" rotation="-90 0 0" position="0 0 -0.04" visible="false"> </a-image>
</a-image>

  <a-image src="#ring-glow" position="-13.3 0.066 -19.5" rotation="90 0 0" scale="25 25 25"
  class="clickable interactive-image" 
  id="teleport-ring1"> 
  <a-image src="#hover-text" class="hover-text" scale="0.11 0.05 0.05" rotation="-90 0 0" position="0 0 -0.04" visible="false"> </a-image>


</a-image>

  <a-image src="#label0" position="-19.5 3.9 -16.5" scale="3.2 2 1" look-at="#cameraRig"> </a-image>
  <a-image src="#label1" position="-13.5 3.9 -20.5" scale="3.2 2 1" look-at="#cameraRig"> </a-image>

    
  <audio id="room-intro" >
    <source src="./Audio/UMTRI.mp3" type="audio/mp3">
  </audio>

      
  <audio id="hallway-audio" >
    <source src="./Audio/hallway.mp3" type="audio/mp3">
  </audio>

  </a-scene>




<div class="nav-container">
  <!-- <input type="checkbox" id="toggle" checked /> -->
  <!-- <label class="button" for="toggle"> -->
    <nav class="nav">
      <ul>
        <li><a href="./index.html"><img src="Images/home-new.png" width="50%">
        <button class="tooltip"> HOME </button>
        </a></li>
        <!-- <li><a href="./room1.html"><img src="Images/menu-new.png" width="50%"></a></li> -->
        <li><a id="studies-button" href="#"><img src="Images/menu-new.png" width="50%">
          <button class="tooltip"> STUDIES </button>
        
        </a> </li>
        <li><a id="audio-toggle" href="#">
          <img  id="audio-icon" src="Images/audio.png" width="50%" style="display:block">
          <button class="tooltip"> AUDIO </button>
          <img id="audio-icon-mute" src="Images/audio-muted.png" width="50%" style="display:none;">
        </a></li>
      </ul>
    </nav>
  </label>
</div>

<div id="studies-detail" class="studies-info" style="display: none;">
  <h4>EXPLORE OTHER STUDIES</h4>
  <a href="./room1.html" class="study-link">Strength Study</a>
  <a href="./room_bodyshape.html" class="study-link">Size and Shape Study</a>
</div>


<!-- <div id="loading-screen" style="position: absolute; width: 100%; height: 100%; background: black; color: white; display: flex; justify-content: center; align-items: center; z-index: 10;">
  <div id="loading-text">Loading... 0%</div>
</div> -->

<div class="overlay" id="overlay"></div>
<div id="loading-screen" style="position: fixed; width: 100%; height: 100%; background-color: black; color: white; display: flex; flex-direction:column; justify-content: center; align-items: center; z-index: 10;">
<img src="Images/loading.png" class="tutorial">
<div class="welcome-text">
  Take a deep breath, your journey to UMTRI awaits!
</div>
</div>


<div class="container" id="panel-1" style="display: none">
  <img src="Images/umtri.png" class="tutorial">
  <div class="welcome-text">
      Welcome to the University of Michigan Transportation Research Institute! Here you can explore the lab space and find out how biosciences research studies are conducted!
  </div>
  <button class="start-button" onclick="closePanel('panel-1'); closePanel('overlay'); openPanel('infoPanel')"> Enter Space </button>
</div>


<div id="infoPanel" class="flex-container">
  <img class="tutorial" src="./Images/nav-tips.png">
  <button class="clickable start-button" onclick="closePanel('infoPanel')"> Try it now </button>
</div>

<div id="subtitle-container" style="display: none; position: absolute; bottom: 10%; left:25%; width: 50%; text-align: center; color: white; font-size: 16px; z-index: 999;background-color: rgba(0, 0, 0, 0.75); padding: 10px 0;">
  <span id="subtitles">You have entered the hallway. 
    Explore different rooms to see what studies are going on </span>
</div>
  
<div id="subtitle-intro" style="display: none; position: absolute; bottom: 10%; left:25%; width: 50%; text-align: center; color: white; font-size: 16px; background-color: rgba(0, 0, 0, 0.75); padding: 10px 0; z-index: 999;">
  Welcome to the University of Michigan Transportation Research Institute! Here you can explore the lab space and find out how biosciences research studies are conducted!
</div>

  <script>

    AFRAME.registerComponent('proximity-audio-trigger', {
      schema: {
          targetPosition: {type: 'vec3', default: {x: -17, y: 0, z: -12}},
          threshold: {type: 'number', default: 3}
      },
      init: function () {
          this.audioPlayed = false;
          this.el.addEventListener('componentchanged', (evt) => {
              if (evt.detail.name === 'position') {
                  this.checkProximity();
              }
          });
      },
      checkProximity: function () {
          if (this.audioPlayed) return;
          const position = this.el.getAttribute('position');
          const distance = this.calculateDistance(position, this.data.targetPosition);
          const subtitles = document.getElementById('subtitles');
          const subtitleContainer = document.getElementById('subtitle-container');
          if (distance < this.data.threshold) {
              const audio = document.querySelector('#hallway-audio');
              if (audio && !audio.isPlaying) {
                  audio.play();
                  subtitleContainer.style.display = 'block'; // Show subtitles
                  this.audioPlayed = true;
                  // Hide subtitles when audio ends
                  audio.addEventListener('ended', () => {
                      subtitleContainer.style.display = 'none';
                  });
              }
          }
      },
      calculateDistance: function (pos1, pos2) {
          const dx = pos1.x - pos2.x;
          const dz = pos1.z - pos2.z;
          return Math.sqrt(dx * dx + dz * dz);
      }
  });

  document.addEventListener('DOMContentLoaded', function() {
    const audio = document.getElementById('room-intro');
    const audioToggleButton = document.getElementById('audio-toggle');
    const audioIcon = document.getElementById('audio-icon');
    const audioIconMute = document.getElementById('audio-icon-mute');
    const subtitleContainer = document.getElementById('subtitle-intro');

    // Initialize audio setting
    if (localStorage.getItem('audioEnabled') === null) {
        localStorage.setItem('audioEnabled', 'true');
    }

    // Check audio setting and set initial audio and subtitle state
    const shouldPlay = localStorage.getItem('audioEnabled') === 'true';
    if (shouldPlay) {
        setTimeout(() => {
            audio.play();
            subtitleContainer.style.display = 'block'; // Show subtitles with delay
        }, 1500);
    }

    // Handle audio toggle
    audioToggleButton.addEventListener('click', function(event) {
        event.preventDefault();
        if (audio.paused) {
            setTimeout(() => {
                audio.play();
                localStorage.setItem('audioEnabled', 'true');
                subtitleContainer.style.display = 'block'; // Show subtitles when audio plays
                audioIcon.style.display = 'none';
                audioIconMute.style.display = 'block';
                audioIconMute.style.marginTop = '-3px';
            }, 1000);
        } else {
            audio.pause();
            localStorage.setItem('audioEnabled', 'false');
            subtitleContainer.style.display = 'none'; // Hide subtitles when audio pauses
            audioIcon.style.display = 'block';
            audioIconMute.style.display = 'none';
        }
    });

    // Ensure subtitles hide when audio ends
    audio.addEventListener('ended', function() {
        subtitleContainer.style.display = 'none';
        audioIcon.style.display = 'block';
        audioIconMute.style.display = 'none';
    });
});

    function closePanel(panelId) {
      document.getElementById(panelId).style.display = "none";
  }
  
  function openPanel(panelId) {
      document.getElementById(panelId).style.display = "flex";
  }

  



document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const cameraPosition = urlParams.get('cameraPosition');
  if (cameraPosition) {
      const positionArray = cameraPosition.split(',').map(Number);
      const cameraRig = document.querySelector('#cameraRig');
      if (cameraRig) {
          cameraRig.setAttribute('position', {x: positionArray[0], y: positionArray[1], z: positionArray[2]});
          document.getElementById('overlay').style.display = 'none';
          document.getElementById('loading-screen').style.display = 'none';
          document.getElementById('panel-1').style.display = 'none';
  
          console.log("success");
      }
  }
  else{

      setTimeout(() => {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('panel-1').style.display = 'block';
  }, 1800); // 2500 milliseconds = 2.5 seconds
  }
});

  
    document.addEventListener('DOMContentLoaded', function() {
      // Define an array of objects containing the selector for each ring and the target URL
      const rings = [
          { selector: '#teleport-ring0', url: './room1.html' },
          { selector: '#teleport-ring1', url: './room_bodyshape.html' },
          { selector: '#exit', url: './index.html' }
      ];
  
      // Iterate over the array and add an event listener to each ring
      rings.forEach(ring => {
          const element = document.querySelector(ring.selector);
          element.addEventListener('click', function() {
              window.location.href = ring.url;
          });
      });
  });

  document.addEventListener('DOMContentLoaded', function() {
    var studiesButton = document.getElementById('studies-button'); // The button to toggle the studies detail
    var studiesDetail = document.getElementById('studies-detail'); // The container for the studies links
    
    studiesButton.addEventListener('click', function(event) {
      event.preventDefault(); // Prevent the default anchor action
      var isHidden = studiesDetail.style.display === 'none';
      studiesDetail.style.display = isHidden ? 'block' : 'none';
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    const images = document.querySelectorAll('.interactive-image');

    images.forEach((image) => {
        const text = image.querySelector('.hover-text');

        image.addEventListener('mouseenter', () => text.setAttribute('visible', true));
        image.addEventListener('mouseleave', () => text.setAttribute('visible', false));
    });
});





AFRAME.registerComponent('restrict-movement', {
  schema: {
    minX: { type: 'number', default: -10 },
    maxX: { type: 'number', default: 10 },
    minZ: { type: 'number', default: -10 },
    maxZ: { type: 'number', default: 10 }
  },
  tick: function () {
    var position = this.el.getAttribute('position');
    
    if (position.x < this.data.minX) {
      position.x = this.data.minX;
    } else if (position.x > this.data.maxX) {
      position.x = this.data.maxX;
    }
    
    if (position.z < this.data.minZ) {
      position.z = this.data.minZ;
    } else if (position.z > this.data.maxZ) {
      position.z = this.data.maxZ;
    }
    
    this.el.setAttribute('position', position);
  }
});
  </script>
</body>

</html>
